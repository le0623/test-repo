# Rust Workspace Release Automation: Complete Guide

## The Ultimate Guide to release-plz + cargo-dist + git-cliff for Rust Workspaces

### Overview

This guide documents real-world issues and solutions for automating releases in Rust workspace projects using the popular toolchain of release-plz, cargo-dist, and git-cliff. Based on extensive research and debugging of actual release failures.

## Table of Contents

1. [Common Problems and Root Causes](#common-problems-and-root-causes)
2. [Tool Configuration Reference](#tool-configuration-reference)
3. [Working Examples](#working-examples)
4. [Best Practices](#best-practices)
5. [Troubleshooting Guide](#troubleshooting-guide)
6. [Complete Working Setup](#complete-working-setup)

## Common Problems and Root Causes

### Problem 1: Empty Changelogs Despite Having Conventional Commits

**Symptoms**: 
- CHANGELOGs only contain `<!-- generated by git-cliff -->` comments
- Manual git-cliff runs produce content but release-plz doesn't

**Root Causes**:
1. **Tag Pattern Mismatch**: git-cliff expects `v1.0.0` but your tags are `package-v1.0.0`
2. **Workspace Confusion**: Per-package changelogs vs. root changelog
3. **Path Filtering**: git-cliff not filtering commits by package directory

**Solution**:
```toml
# cliff.toml
[git]
tag_pattern = ".*-v[0-9]*"  # Match package-v1.0.0 format
# OR for simple tags:
tag_pattern = "v[0-9]*"     # Match v1.0.0 format
```

### Problem 2: cargo-dist Workflow Not Triggering

**Symptoms**:
- GitHub release created but no binaries attached
- Release workflow never runs despite tag being pushed

**Root Causes**:
1. **Workflow Tag Pattern Incorrect**: Pattern like `redisctl**[0-9]+.[0-9]+.[0-9]+*` doesn't match `redisctl-v0.2.0`
2. **Configuration Drift**: Manually edited workflow diverged from cargo-dist expectations

**Solution**:
```yaml
# .github/workflows/release.yml
on:
  push:
    tags:
      - 'redisctl-v*'  # Correct pattern for package-v format
```

### Problem 3: Multiple Tools Creating GitHub Releases

**Symptoms**:
- Race conditions between release-plz and cargo-dist
- Duplicate or conflicting GitHub releases
- Binary artifacts missing from releases

**Root Cause**:
Both release-plz and cargo-dist try to create GitHub releases

**Solution**:
```toml
# release-plz.toml
[workspace]
git_release_enable = false  # Let cargo-dist handle GitHub releases
git_tag_enable = true       # release-plz only creates tags
```

### Problem 4: Version Conflicts Between Local and Crates.io

**Symptoms**:
- Error: "package has different version with respect to registry"
- Release process blocked by existing tags

**Root Causes**:
1. Manual version bumps conflicting with release-plz
2. Draft releases blocking automation
3. Tags existing without corresponding crates.io publishes

**Solution**:
- Never manually bump versions - let release-plz handle it
- Delete draft releases before running release-plz
- Keep versions in sync: local = git tags = crates.io

## Tool Configuration Reference

### release-plz.toml (Complete Working Example)

```toml
[workspace]
# Changelog generation
changelog_update = true
changelog_config = "cliff.toml"

# Dependencies
dependencies_update = true

# Git configuration  
allow_dirty = false
git_release_enable = false  # Let cargo-dist handle releases
git_tag_enable = true

# PR settings
pr_labels = ["release"]

# Publish settings
publish = true
publish_allow_dirty = false
publish_timeout = "15m"

# Per-package configuration
[[package]]
name = "package1"
changelog_update = true

[[package]]
name = "package2"  
changelog_update = true

[[package]]
name = "main-package"
changelog_update = true
release = true  # Only this creates GitHub release via cargo-dist
```

### cliff.toml (Workspace-Compatible)

```toml
[changelog]
header = """
# Changelog
All notable changes to this project will be documented in this file.
"""
body = """
{% if version %}\
    ## [{{ version | trim_start_matches(pat="v") }}] - {{ timestamp | date(format="%Y-%m-%d") }}
{% else %}\
    ## [unreleased]
{% endif %}\
{% for group, commits in commits | group_by(attribute="group") %}
    ### {{ group | upper_first }}
    {% for commit in commits %}
        - {% if commit.breaking %}[**breaking**] {% endif %}{{ commit.message | upper_first }}\
    {% endfor %}
{% endfor %}\n
"""
trim = true
footer = """
<!-- generated by git-cliff -->
"""

[git]
conventional_commits = true
filter_unconventional = true
commit_parsers = [
    { message = "^feat", group = "Features" },
    { message = "^fix", group = "Bug Fixes" },
    { message = "^docs?", group = "Documentation" },
    { message = "^perf", group = "Performance" },
    { message = "^refactor", group = "Refactoring" },
    { message = "^style", group = "Style" },
    { message = "^test", group = "Testing" },
    { message = "^chore\\(release\\): prepare for", skip = true },
    { message = "^chore", group = "Miscellaneous" },
]
protect_breaking_commits = false
filter_commits = false
# CRITICAL: Match your actual tag format
tag_pattern = ".*-v[0-9]*"  # For package-v1.0.0 format
# OR
# tag_pattern = "v[0-9]*"    # For v1.0.0 format
sort_commits = "oldest"
```

### dist-workspace.toml (cargo-dist Configuration)

```toml
[dist]
# Version of cargo-dist to use
cargo-dist-version = "0.29.0"

# CI backends
ci = "github"

# Installers
installers = []

# Target platforms
targets = [
    "aarch64-apple-darwin",
    "aarch64-unknown-linux-gnu",
    "x86_64-apple-darwin",
    "x86_64-unknown-linux-gnu",
    "x86_64-pc-windows-msvc",
]

# Path to Cargo.toml
manifest-path = "./Cargo.toml"

# Tag namespace for releases
tag-namespace = "redisctl"  # Creates redisctl-v1.0.0 tags

# Don't error on uncommitted changes
allow-dirty = ["ci"]

# GitHub Release settings
github-releases = "announce"
```

### Cargo.toml (Workspace Configuration)

```toml
[workspace]
resolver = "2"
members = [
    "crates/package1",
    "crates/package2",
    "crates/main-package",
]

# CRITICAL: Use workspace dependencies to avoid version conflicts
[workspace.package]
version = "0.1.0"  # Single source of truth
edition = "2021"   # or "2024" if using Rust 1.89+
rust-version = "1.75"
authors = ["Your Name <email@example.com>"]
license = "MIT OR Apache-2.0"
repository = "https://github.com/user/repo"

[workspace.dependencies]
# Shared dependencies with unified versions
tokio = { version = "1.40", features = ["full"] }
serde = { version = "1.0", features = ["derive"] }
# ... other shared deps

# Internal crate dependencies - use workspace version
package1 = { path = "crates/package1", version = "0.1.0" }
package2 = { path = "crates/package2", version = "0.1.0" }
```

## Working Examples

### Example 1: Simple Workspace Release Flow

```bash
# 1. Make changes following conventional commits
git add -A
git commit -m "feat: add new feature"
git push

# 2. release-plz creates PR automatically
# 3. Merge PR - this triggers:
#    - release-plz publishes to crates.io
#    - release-plz creates git tags
#    - cargo-dist builds binaries
#    - cargo-dist creates GitHub release with artifacts
```

### Example 2: Testing Changelog Generation

```bash
# Test git-cliff directly
git cliff --tag-pattern "package-v[0-9]*" \
         --include-path "crates/package1/**" \
         package-v0.1.0..HEAD

# Test release-plz changelog generation
RELEASE_PLZ_LOG=debug release-plz update --dry-run
```

### Example 3: Fixing Version Conflicts

```bash
# If you get version conflicts:
# 1. Delete any draft releases on GitHub
gh release list --exclude-pre-releases=false
gh release delete <draft-release> -y

# 2. Delete conflicting tags
git tag -d redisctl-v0.2.0
git push origin :redisctl-v0.2.0

# 3. Reset versions in Cargo.toml to match crates.io
# Edit workspace version to match published version

# 4. Let release-plz handle everything
git push  # Triggers release-plz
```

## Best Practices

### 1. Version Management
- **NEVER** manually bump versions in Cargo.toml
- Let release-plz handle all version updates
- Use `[workspace.package]` version as single source of truth
- Keep all workspace members on same version initially

### 2. Conventional Commits
- Use strict conventional commit format
- Examples:
  - `feat: add new API endpoint`
  - `fix: resolve connection timeout issue`
  - `docs: update README with examples`
  - `feat!: breaking change to API`

### 3. Workflow Coordination
- release-plz: Creates tags and publishes to crates.io
- cargo-dist: Builds binaries and creates GitHub releases  
- Docker: Triggers on release publication
- Never have multiple tools create GitHub releases

### 4. Testing Releases
- Use release candidates: `v0.1.0-rc.1`
- Test with `--dry-run` flags
- Verify changelog generation before releasing
- Monitor all workflow runs during release

### 5. Workspace Dependencies
```toml
# In member crates, reference workspace version
[package]
name = "my-crate"
version.workspace = true
edition.workspace = true

[dependencies]
# Reference internal crates with workspace version
other-crate = { path = "../other-crate", version = "0.1.0" }
```

## Troubleshooting Guide

### Issue: "failed to parse changelog"
**Solution**: Ensure cliff.toml tag_pattern matches your actual tags

### Issue: "package has different version"
**Solution**: Delete conflicting tags and let release-plz manage versions

### Issue: No binaries in GitHub release
**Solution**: Fix cargo-dist workflow tag pattern trigger

### Issue: Empty changelogs
**Solution**: Check tag_pattern in cliff.toml matches your tags

### Issue: Workflows not triggering
**Solution**: Verify GitHub Actions permissions and branch protection rules

### Issue: Docker build fails during release
**Solution**: Ensure Cargo.lock is committed and Dockerfile is updated

## Complete Working Setup

### Step 1: Initialize Tools

```bash
# Install tools
cargo install release-plz cargo-dist git-cliff

# Initialize cargo-dist
dist init
# Select: github CI, your platforms, tag-namespace

# Initialize release-plz
# Create release-plz.toml manually (see above)

# Create cliff.toml manually (see above)
```

### Step 2: Configure GitHub Repository

1. Add secrets:
   - `CARGO_REGISTRY_TOKEN` - crates.io token
   - `GITHUB_TOKEN` - automatically provided
   - `DOCKERHUB_TOKEN` - if using Docker

2. Configure branch protection:
   - Require PR reviews
   - Require status checks
   - Include administrators

3. Enable GitHub Actions:
   - Allow GitHub Actions to create PRs
   - Allow GitHub Actions to create releases

### Step 3: Commit Configuration

```bash
# Add all config files
git add release-plz.toml cliff.toml dist-workspace.toml
git add .github/workflows/
git commit -m "chore: configure release automation"
git push
```

### Step 4: Create First Release

```bash
# Make a change
git add -A  
git commit -m "feat: initial release setup"
git push

# Wait for release-plz PR
# Merge PR
# Watch the magic happen
```

## Lessons Learned

1. **Start Simple**: Don't try to configure everything at once
2. **One Tool Per Job**: Don't have multiple tools doing the same thing
3. **Match Tag Patterns**: Ensure all tools agree on tag format
4. **Test Incrementally**: Test each tool separately before integrating
5. **Monitor Releases**: Watch all workflow runs during releases
6. **Document Everything**: Future you will thank present you

## References

- [release-plz Documentation](https://release-plz.ieni.dev/)
- [cargo-dist Documentation](https://opensource.axo.dev/cargo-dist/)
- [git-cliff Documentation](https://git-cliff.org/)
- [Conventional Commits](https://www.conventionalcommits.org/)

## Contributing

Found an issue or have an improvement? Please contribute back to help others!

---

*Last updated: 2025-08-29*
*Based on real-world debugging of redisctl and mdbook-lint projects*